# **Helm Tutorial**

## **NOTICE: Please remember to uninstall the app from helm if you don't use it!!**

Helm is a package manager for Kubernetes. You can think of Helm as a tool for you to get a prebuilt templates since you usually need mutliple Kubernetes object at a time.

## **Purpose**

---
Due to software development becoming more micro-service-oriented, people build specific apps with different dependencies and settings in parallel. To speed up the process, companies use Kubernetes to manage the projects, and it turns out that too many Kubernetes objects need to be managed.

Thus, Helm is the very tool to help you:

* Manage and deploy different Kubernets object with very little command.

* Centralized Management on the configuration so that you don't need to edit the same value across different Kubernets objects.

* A popular place to deploy, diff, check history, monitoryour app.

## **Important conponents in Helm**

---

1. Chart: A collection of Kubernetes objects/files
2. Repository: A place where you save your chart
3. Release: An instance created by the chart. One chart can produce many releases. Release is generated by this command: `helm install <the folder to Chart>`

## **How does it work**

When deploying things on Kubernete, you need at least three objects to launch you applications, which are `deployment`, `service`, and `ingress` (We don't reccommend use to `NodePort` in production and not using `ingress`).

To simplify the work and make your Kubernetes reusable, Helm use somehting call `Values` to store shared avariables. Then use `Chart` to generalize your Kubernete files. Last we put your `deployment`, `service`, and `ingress` into a folder called `templates`. You are using the same files in Kubernetes by just replacing the shared variables `{{ .Values.variable }}`. The structure will be:

    ```
    <the_name_of_chart>/
        Chart.yaml          # A YAML file containing information about the chart
        LICENSE             # OPTIONAL: A plain text file containing the license for the chart
        README.md           # OPTIONAL: A human-readable README file
        values.yaml         # The default configuration values for this chart
        values.schema.json  # OPTIONAL: A JSON Schema for imposing a structure on the values.yaml file
        charts/             # A directory containing any charts upon which this chart depends.
        crds/               # Custom Resource Definitions
        templates/          # A directory of templates that, when combined with values,
                            # will generate valid Kubernetes manifest files.
            deployment.yaml
            service.yaml
            ingress.yaml
            NOTES.txt       # OPTIONAL: A plain text file containing short usage notes
    ```

## **Helm Applications - Host an API**

---

## **Examples**

We recommendation you start with `Api_HelmKubernetes` unless your are not familiar with ML models.

* **Api_Base:** A hello world API, this is the basic format**
* **Api_HelmKubernetes:** A API for keepstock project**
* **Running Examples: <https://keepstockapi-v8.aad.prodaws.grainger.com/docs#/default/predict_species_predict_post>**

## **How to run the example**

1. Build an image wfrom your local (We are looking for better solutions since pushing to AWS ERC takes huge amount of time)

    `docker build -t <image_name:version> .`

2. Login to AWS ECR

    `aws ecr get-login-password --region us-east-2 --profile prod | docker login --username AWS --password-stdin 709741256416.dkr.ecr.us-east-2.amazonaws.com/<your-repo-registered-from-MLOps-team>`

3. Tag the image in this format

    `docker tag <image_name:version> 709741256416.dkr.ecr.us-east-2.amazonaws.com/<your-repo-registered-from-MLOps-team>:<new_image_name_for_ecr>`

4. Push the image to ECR (You may use the `push2ecr` but remember to edit the content )

    `docker push 709741256416.dkr.ecr.us-east-2.amazonaws.com/<your-repo-registered-from-MLOps-team>:<new_image_name_for_ecr>`

5. Run Kubernetes with Helm

    `helm install <the folder to Chart> --generate-name -n <your-or-team-name-space>`  -> **Chart folder should be lowercase**

6. Direct to the URL from the place you set in `ingress.yaml`, if your set your values `app: apiyeah` and `environment: prod` (prod/dev only) in `values.yaml`. Then the URL will be

**`https://apiyeah.aad.prodaws.grainger.com/`**

    6.1: One way to remember the URL is to go to `values.yaml` to see the URL:

    ```yaml
    kind: Ingress
    apiVersion: networking.k8s.io/v1beta1
    metadata:
    ...
    spec:
    rules:
        - http:
            paths:
            - backend:
                serviceName: {{ .Values.app }}
                servicePort: {{ .Values.service_port }}
                path: "/"
                pathType: Prefix
        host: {{ .Values.app }}.aad.{{ .Values.environment }}aws.grainger.com  # Here!
    ```

    6.2 Another way is to type in terminal:
    `kubectl describe ingress`

## **How to apply to your projects**

From now on, you just need to create the following things. You may use `docker run` or `docker-compose` to debug first.

1. Create and push Docker image
2. Put your project in app folder
3. Edit the resource and image you need in `values.yaml` file and the description in `Chart.yaml`
4. Done!

## **Learning Resource**

---
You will only need to learn the concept of Helm with additional commands like `helm install`, `helm uninstall`, `helm list` at minimum.

1. [Helm Official Website](https://helm.sh/)
2. [Helm founamentals from IBM](https://www.ibm.com/cloud/architecture/content/course/helm-fundamentals)
